$(function () { LKLog_Pawd.init_login() }); $(document).keydown(function (a) { if (a.keyCode == 13) switch (LKLog_Pawd.cur_state) { case "login": LKLog_Pawd.re_smt_login(); break; case "fpawd": LKLog_Pawd.re_smt_fpawd(); break; default: return false } }); var LKLog_Pawd = { cur_state: "login", elem_win_login: 0, elem_win_pawd: 0, elem_win_smail: 0, elem_text_uname: 0, elem_text_upawd: 0, elem_text_fpawd: 0, elem_smt_login: 0, elem_smt_fpawd: 0, options: { isiframe: false }, init_login: function () { var a = GlobalManage.getUrlArg(), d = a.isiframe, c = a.uname || "", b = a.uemail || "", e = a.ismsg; this.options.isiframe = d == "true" ? true : false; this.init_Reg(); this.elem_win_login = $("#Login"); this.elem_text_uname = $("#uname").focus().select().select(function () { this.style.color = "#333" }).click(function () { LKLog_Pawd.exeText(this, "click") }); this.elem_text_upawd = $("#upawd"); this.elem_smt_login = $("#smt_login"); if (c || b) { this.elem_text_uname.val(b || c); this.elem_text_upawd.focus() } if (e == "true") { this.tipMsg(); this.tipMsg_cont("对不起，您还没登录！"); this.tipMsg_show($("#smt_login")) } }, init_Reg: function () { var b = document.getElementById("Login_Reg_0") || {}, c = document.getElementById("Login_Reg_1") || {}, d = this.options.isiframe, a = "/Common/LoginReg/Register.htm?isiframe=" + (d ? "true" : "false"); b.href = a; c.href = a }, init_fpawd: function () { this.elem_win_pawd = this.elem_win_pawd || $("#Pawd"); this.elem_text_fpawd = this.elem_text_fpawd || $("#fpawd").select(function () { this.style.color = "#333" }).click(function () { LKLog_Pawd.exeText(this, "click") }); this.elem_smt_fpawd = this.elem_smt_fpawd || $("#smt_fpawd") }, init_smail: function () { this.elem_win_smail = this.elem_win_smail || $("#SendEmail") }, switch_win: function (c) { var a = this; if (c == "login") { a.tipMsg_hide(); var b; switch (this.cur_state) { case "fpawd": b = this.elem_win_pawd; break; case "semail": b = this.elem_win_smail; break; default: return false } b.fadeOut("fast", function () { a.elem_text_upawd.val(""); a.elem_win_login.fadeIn("fast", function () { a.elem_text_uname.focus().select(); a.cur_state = "login" }) }) } else if (c == "fpawd") { this.init_fpawd(); a.tipMsg_hide(); a.elem_win_login.fadeOut("fast", function () { a.elem_win_pawd.fadeIn("fast", function () { a.elem_text_fpawd.focus().select(); a.cur_state = "fpawd" }) }) } else if (c == "semail") { a.tipMsg_hide(); a.elem_win_pawd.fadeOut("fast", function () { a.elem_win_smail.fadeIn("fast", function () { a.cur_state = "semail" }) }) } }, getOffset: function (c) { var a = $(c), d = a.offset().top, b = a.offset().left; return { top: d, left: b} }, getPosition: function (c) { var a = $(c), d = a.position().top, b = a.position().left; return { top: d, left: b} }, get_lk_lr: function () { return this.options.isiframe ? parent.LK_LoginReg : LK_LoginReg }, set_boxy_title: function (b) { var a = this.get_lk_lr(); a && a.title(b) }, tipMsg_box: 0, tipMsg_init: function () { this.tipMsg_box = this.tipMsg_box || new MsgBox("", { bgColor: "#ffff99", innerStyle: "" }) }, tipMsg_show: function (a) { this.tipMsg_site(a); this.tipMsg_box.show({ speed: 1 }) }, tipMsg_hide: function () { this.tipMsg_box && this.tipMsg_box.hide() }, tipMsg_bg: function (a) { this.tipMsg_box.setBgColor(a) }, tipMsg_cont: function (a) { a = '<div class="tipmsg">' + a + "</div>"; this.tipMsg_box.setContent(a) }, tipMsg_site: function (e) { var c = 178, b = 10, d = this.get_lk_lr(); if (d && d.boxy == 0 && location.pathname.indexOf("/Account/LogOn") != -1) { c = 185; b = 0 } var a = this.getOffset(e); a.top -= this.cur_state == "login" ? c : 108; a.left -= b; this.tipMsg_box.setElemAnimate(a) }, tipMsg: function () { this.tipMsg_init() }, trim: function (a) { return (a || "").replace(/(^\s*)|(\s*$)/g, "") }, re_smt_login: function () { this.elem_smt_login && this.elem_smt_login.click() }, re_smt_fpawd: function () { this.elem_smt_fpawd && this.elem_smt_fpawd.click() }, exeText: function (a, d) { var c = this.trim(a.value), b = a.label; if (d == "click") { if (c == b) a.value = ""; a.style.color = "#333" } else if (d == "focus") { if (c != b) a.style.color = "#333" } else if ("blur") if (c == "" || c == b) { a.value = b || ""; a.style.color = "#888" } else a.style.color = "#333" }, login_blur: function () { this.elem_text_uname.blur(); this.elem_text_upawd.blur() }, login_success: function (d) { var a = this, b = a.get_lk_lr(); if (b) b.data.现登录或注册已成功 = true; if (b && b.boxy == 0 && location.pathname.indexOf("/Account/LogOn") != -1) { var c = GlobalManage.getUrlArg().ReturnUrl; c = decodeURIComponent(c || ""); if (c) location.href = c; else location.href = "/Home/Index"; return } a.tipMsg_cont('<span style="color:Green;">您已登录成功！</span>'); a.tipMsg_show(d); a.login_submit_set({ is提交状态: false, is提交按钮: false, is对话框按钮: true, is可点击链接: false }); setTimeout(function () { a.tipMsg_hide(); a.login_submit_set({ is提交状态: false, is提交按钮: true, is对话框按钮: false, is可点击链接: false }); a.login_blur(); b && b.hide() }, 500) }, is_login_submit: false, login_submit_set: function (a) { var b = a.is提交状态 || false; if (a.is提交按钮) if (b) { this.is_login_submit = true; this.elem_smt_login.attr("disabled", "disabled") } else { this.is_login_submit = false; this.elem_smt_login.removeAttr("disabled") } if (a.is对话框按钮) { var c = this.get_lk_lr(); c && c.close_btn(!b) } a.is可点击链接 && $("#Login_Right").css("display", b ? "none" : "block") }, login_submit: function (b) { if (this.is_login_submit) return false; this.tipMsg(); var c = this.trim(this.elem_text_uname.val()), f = this.elem_text_uname.attr("label"), e = this.elem_text_uname.attr("tips") || "用户名", d = this.trim(this.elem_text_upawd.val()); if (c == f) { this.tipMsg_cont("请输入您的" + e); this.elem_text_uname.select(); this.tipMsg_show(b) } else if (c == "") { this.tipMsg_cont("请输入您的" + e); this.elem_text_uname.focus(); this.tipMsg_show(b) } else if (d == "") { this.tipMsg_cont("请输入您的密码"); this.elem_text_upawd.focus(); this.tipMsg_show(b) } else { this.login_submit_set({ is提交状态: true, is提交按钮: true, is对话框按钮: true, is可点击链接: true }); this.tipMsg_cont("正在登录您的账号,请稍等......"); this.login_blur(); this.tipMsg_show(b); var a = this; $.ajax({ url: "/Account/LogOnAjax/", type: "POST", data: { UserName: c, Password: d, RememberMe: $("#ustate").attr("checked") }, dataType: "json", timeout: 6e4, cache: false, success: function (c) { if (c.result) a.login_success(b, c.info); else { a.tipMsg_cont(c.info || "账号或密码不太对吧！ 重试一次？"); a.tipMsg_show(b); a.elem_text_upawd.select(); a.login_submit_set({ is提交状态: false, is提交按钮: true, is对话框按钮: true, is可点击链接: true }) } }, error: function (d, c) { a.login_submit_set({ is提交状态: false, is提交按钮: true, is对话框按钮: true, is可点击链接: true }); switch (c) { case "timeout": a.tipMsg_cont('对不起！登录已超时，重新<a style="margin-left:3px; color:#369" href="javascript:void(0)" onclick="LKLog_Pawd.re_smt_login();">登录</a>'); a.tipMsg_show(b) } } }) } }, fpawd_success: function () { this.init_smail(); this.switch_win("semail") }, is_fpawd_submit: false, fpawd_submit_set: function (a) { if (a) { this.is_fpawd_submit = true; this.elem_smt_fpawd.attr("disabled", "disabled") } else { this.is_fpawd_submit = false; this.elem_smt_fpawd.removeAttr("disabled") } }, fpawd_submit: function (b) { if (this.is_fpawd_submit) return false; this.tipMsg(); var c = this.trim(this.elem_text_fpawd.val()), d = this.elem_text_fpawd.attr("label"); if (c == d) { this.tipMsg_cont("请输入您的E-Mail地址"); this.elem_text_fpawd.select(); this.tipMsg_show(b) } else if (c == "") { this.tipMsg_cont("请输入您的E-Mail地址"); this.elem_text_fpawd.focus(); this.tipMsg_show(b) } else if (!/^\w+((-\w+)|(\.\w+))*\@[A-Za-z0-9]+((\.|-)[A-Za-z0-9]+)*\.[A-Za-z0-9]+$/.test(c)) { this.tipMsg_cont("您输入的E-Mail地址格式错误"); this.elem_text_fpawd.focus(); this.tipMsg_show(b) } else { this.fpawd_submit_set(true); this.tipMsg_cont("正在提交您的E-Mail地址,请稍等......"); this.tipMsg_show(b); var a = this; $.ajax({ url: "/Common/Ajax/Log_Reg.aspx", data: { action: "log_reg_取回密码", e_mail: c }, dataType: "json", timeout: 6e4, cache: false, success: function (c) { if (c.result) a.fpawd_success(); else { a.tipMsg_cont(c.info); a.tipMsg_show(b) } a.fpawd_submit_set(false) }, error: function (d, c) { a.fpawd_submit_set(false); switch (c) { case "timeout": a.tipMsg_cont('对不起！取回密码已超时，重新<a style="margin-left:3px; color:#369" href="javascript:void(0)" onclick="LKLog_Pawd.re_smt_fpawd();">提交</a>'); a.tipMsg_show(b) } } }) } } }